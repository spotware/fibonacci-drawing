using cAlgo.API;
using System;
using System.Collections.Generic;
using System.Linq;

namespace cAlgo.Helpers
{
    public static class BarsFutureOpenTime
    {
        public static DateTime GetOpenTime(this Bars bars, double barIndex)
        {
            var currentIndex = bars.Count - 1;

            TimeSpan timeDiff = bars.GetTimeDiff();

            var indexDiff = barIndex - currentIndex;

            var indexDiffAbs = Math.Abs(indexDiff);

            var result = indexDiff <= 0 ? bars.OpenTimes[(int)barIndex] : bars.OpenTimes[currentIndex];

            if (indexDiff > 0)
            {
                for (var i = 1; i <= indexDiffAbs; i++)
                {
                    do
                    {
                        result = result.Add(timeDiff);
                    }
                    while (result.DayOfWeek == DayOfWeek.Saturday || result.DayOfWeek == DayOfWeek.Sunday);
                }
            }

            var barIndexFraction = barIndex % 1;

            var barIndexFractionInMinutes = timeDiff.TotalMinutes * barIndexFraction;

            result = result.AddMinutes(barIndexFractionInMinutes);

            return result;
        }

        public static DateTime GetBarIndex(this Bars bars, double barIndex)
        {
            var currentIndex = bars.Count - 1;

            TimeSpan timeDiff = bars.GetTimeDiff();

            var indexDiff = barIndex - currentIndex;

            var indexDiffAbs = Math.Abs(indexDiff);

            var result = indexDiff <= 0 ? bars.OpenTimes[(int)barIndex] : bars.OpenTimes[currentIndex];

            if (indexDiff > 0)
            {
                for (var i = 1; i <= indexDiffAbs; i++)
                {
                    do
                    {
                        result = result.Add(timeDiff);
                    }
                    while (result.DayOfWeek == DayOfWeek.Saturday || result.DayOfWeek == DayOfWeek.Sunday);
                }
            }

            var barIndexFraction = barIndex % 1;

            var barIndexFractionInMinutes = timeDiff.TotalMinutes * barIndexFraction;

            result = result.AddMinutes(barIndexFractionInMinutes);

            return result;
        }

        public static TimeSpan GetTimeDiff(this Bars bars)
        {
            var index = bars.Count - 1;

            if (index < 4)
            {
                throw new InvalidOperationException("Not enough data in market series to calculate the time difference");
            }

            var timeDiffs = new List<TimeSpan>();

            for (var i = index; i >= index - 4; i--)
            {
                timeDiffs.Add(bars.OpenTimes[i] - bars.OpenTimes[i - 1]);
            }

            return timeDiffs.GroupBy(diff => diff).OrderBy(diffGroup => diffGroup.Count()).Last().First();
        }
    }
}